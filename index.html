<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON PROTOCOL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body { background-color: #050505; color: #00ff41; font-family: 'VT323', monospace; overflow: hidden; }
        .scanlines { background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 10; }
        @keyframes flicker { 0% { opacity: 0.97; } 50% { opacity: 0.95; } 100% { opacity: 0.97; } }
        .crt-flicker { animation: flicker 0.15s infinite; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #001100; } ::-webkit-scrollbar-thumb { background: #004400; }
        
        .choice-btn:hover:not(:disabled) { background-color: #00ff41; color: #000; cursor: pointer; }
        .choice-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .hud-box { border: 1px solid #004400; background: #001100; padding: 0 8px; }

        /* MAP STYLES */
        .city-node { width: 20px; height: 20px; border: 2px solid #004400; background: #000; border-radius: 50%; position: absolute; cursor: pointer; transition: all 0.3s; }
        .city-node.unlocked { border-color: #00ff41; background: #002200; box-shadow: 0 0 10px #00ff41; }
        .city-node:hover.unlocked { transform: scale(1.5); background: #00ff41; }
        .city-node.active { background: #fff; border-color: #fff; box-shadow: 0 0 15px #fff; }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center crt-flicker">

    <div class="relative w-full max-w-4xl h-[95vh] border-4 border-[#003300] bg-black p-4 rounded-md flex flex-col gap-3">
        <div class="scanlines"></div>
        
        <div class="flex justify-between border-b border-[#00ff41] pb-1 text-xl opacity-80">
            <span>NEON_PROTOCOL // V.7.0</span>
            <span id="current-loc-display" class="text-yellow-400">LOC: NEO-KOWLOON</span>
        </div>

        <div id="char-creation-screen" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center gap-6 p-10 m-2">
            <h1 class="text-4xl text-[#00ff41] text-center tracking-widest animate-pulse">IDENTITY INITIALIZATION</h1>
            <input type="text" id="char-name" class="w-full max-w-md bg-[#001100] border border-[#00ff41] p-2 text-[#00ff41] focus:outline-none" placeholder="HANDLE (NAME)">
            <input type="text" id="char-class" class="w-full max-w-md bg-[#001100] border border-[#00ff41] p-2 text-[#00ff41] focus:outline-none" placeholder="CLASS (e.g. Solo, Netrunner)">
            <input type="text" id="char-style" class="w-full max-w-md bg-[#001100] border border-[#00ff41] p-2 text-[#00ff41] focus:outline-none" placeholder="STYLE (e.g. Chrome arm)">
            <button id="jack-in-btn" class="border border-[#00ff41] p-3 hover:bg-[#00ff41] hover:text-black uppercase tracking-widest w-full max-w-md">JACK IN</button>
        </div>

        <div id="game-ui" class="hidden flex-1 flex flex-col gap-4 h-full relative z-10">
            <div class="flex flex-row gap-2 text-lg">
                <div class="hud-box flex-1">HP: <span id="hp-display" class="text-red-500">100</span></div>
                <div class="hud-box flex-1">CRED: <span id="credits-display" class="text-yellow-400">50</span></div>
                <button id="map-toggle-btn" class="hud-box flex-1 text-center hover:bg-[#00ff41] hover:text-black cursor-pointer border-yellow-500 text-yellow-500">OPEN MAP</button>
            </div>

            <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden relative">
                <div id="map-screen" class="hidden absolute inset-0 bg-black/95 z-40 border border-[#00ff41] flex items-center justify-center">
                    <div class="relative w-[80%] h-[80%] border border-[#004400] bg-[#001100]">
                        <h2 class="absolute top-2 left-2 text-[#00ff41]">SECTOR MAP</h2>
                        <button id="close-map-btn" class="absolute top-2 right-2 border border-red-500 text-red-500 px-2 hover:bg-red-500 hover:text-black">X</button>
                        
                        <div class="city-node unlocked active" style="top: 80%; left: 10%;" data-city="Neo-Kowloon" title="Neo-Kowloon"></div>
                        <div class="city-node" style="top: 60%; left: 30%;" data-city="The Zone" title="The Zone"></div>
                        <div class="city-node" style="top: 40%; left: 50%;" data-city="Solaris District" title="Solaris District"></div>
                        <div class="city-node" style="top: 20%; left: 70%;" data-city="Trantor Deep" title="Trantor Deep"></div>
                        <div class="city-node" style="top: 70%; left: 80%;" data-city="Ubik Reality" title="Ubik Reality"></div>
                        <div class="city-node" style="top: 10%; left: 40%;" data-city="Magrathea Heights" title="Magrathea Heights"></div>

                        <svg class="absolute inset-0 w-full h-full pointer-events-none opacity-30">
                            <line x1="10%" y1="80%" x2="30%" y2="60%" stroke="#00ff41" stroke-width="2" />
                            <line x1="30%" y1="60%" x2="50%" y2="40%" stroke="#00ff41" stroke-width="2" />
                            <line x1="50%" y1="40%" x2="70%" y2="20%" stroke="#00ff41" stroke-width="2" />
                            <line x1="70%" y1="20%" x2="40%" y2="10%" stroke="#00ff41" stroke-width="2" />
                            <line x1="30%" y1="60%" x2="80%" y2="70%" stroke="#00ff41" stroke-width="2" />
                        </svg>
                    </div>
                </div>

                <div class="w-full md:w-1/2 flex flex-col gap-2">
                    <div id="image-container" class="flex-1 border border-[#004400] bg-[#001100] flex items-center justify-center overflow-hidden">
                        <span class="opacity-50">INITIALIZING...</span>
                    </div>
                </div>
                <div class="w-full md:w-1/2 flex flex-col">
                    <div id="story-text" class="flex-1 overflow-y-auto text-lg leading-relaxed whitespace-pre-line p-2 border-l border-[#004400]"></div>
                </div>
            </div>

            <div id="interaction-area" class="border-t border-[#00ff41] pt-4 min-h-[120px]">
                <div id="choice-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <div id="puzzle-container" class="hidden flex gap-2">
                    <div class="text-red-500 animate-pulse">LOCKED >></div>
                    <input id="puzzle-input" class="flex-1 bg-[#001100] border border-[#00ff41] text-[#00ff41] p-2 focus:outline-none" placeholder="SOLVE...">
                    <button id="submit-puzzle-btn" class="border border-[#00ff41] p-2 text-[#00ff41]">SEND</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    class CyberpunkRPG {
        constructor() {
            this.history = [];
            this.currentCity = "Neo-Kowloon";
            this.unlockedCities = ["Neo-Kowloon"];
            this.stats = { hp: 100, credits: 50 };
            this.playerProfile = {};

            this.ui = {
                charScreen: document.getElementById('char-creation-screen'),
                game: document.getElementById('game-ui'),
                map: document.getElementById('map-screen'),
                locDisplay: document.getElementById('current-loc-display'),
                story: document.getElementById('story-text'),
                img: document.getElementById('image-container'),
                choices: document.getElementById('choice-container'),
                puzzle: document.getElementById('puzzle-container'),
                hp: document.getElementById('hp-display'),
                cred: document.getElementById('credits-display')
            };

            this.init();
        }

        init() {
            document.getElementById('jack-in-btn').addEventListener('click', () => {
                this.playerProfile = {
                    name: document.getElementById('char-name').value || "V",
                    class: document.getElementById('char-class').value || "Solo",
                    style: document.getElementById('char-style').value || "Punk"
                };
                this.ui.charScreen.classList.add('hidden');
                this.ui.game.classList.remove('hidden');
                this.startSound();
                this.makeTurn(`Initialize game in ${this.currentCity}.`);
            });

            document.getElementById('map-toggle-btn').addEventListener('click', () => {
                this.ui.map.classList.remove('hidden');
                this.renderMap();
            });
            document.getElementById('close-map-btn').addEventListener('click', () => this.ui.map.classList.add('hidden'));

            document.getElementById('submit-puzzle-btn').addEventListener('click', () => {
                const val = document.getElementById('puzzle-input').value;
                document.getElementById('puzzle-input').value = '';
                this.makeTurn(`Puzzle Answer: ${val}`);
            });
        }

        async startSound() {
            await Tone.start();
            const synth = new Tone.PolySynth().toDestination();
            synth.triggerAttackRelease(["C2", "G2"], "4n");
        }

        renderMap() {
            const nodes = document.querySelectorAll('.city-node');
            nodes.forEach(node => {
                const cityName = node.getAttribute('data-city');
                node.classList.remove('unlocked', 'active');
                
                if (cityName === this.currentCity) node.classList.add('unlocked', 'active');
                else if (this.unlockedCities.includes(cityName)) node.classList.add('unlocked');

                node.onclick = () => {
                    if (this.unlockedCities.includes(cityName) && cityName !== this.currentCity) {
                        this.currentCity = cityName;
                        this.ui.map.classList.add('hidden');
                        this.ui.locDisplay.innerText = `LOC: ${cityName.toUpperCase()}`;
                        this.makeTurn(`Travel to ${cityName}. Describe the arrival.`);
                    }
                };
            });
        }

        async makeTurn(action) {
            this.ui.choices.innerHTML = '<div class="text-[#00ff41] animate-pulse">PROCESSING...</div>';

            try {
                const res = await fetch('/api/turn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: this.history,
                        userAction: action,
                        currentStats: this.stats,
                        playerProfile: this.playerProfile,
                        currentCity: this.currentCity
                    })
                });

                const data = await res.json();
                
                if (data.stats) this.stats = data.stats;
                this.ui.hp.innerText = this.stats.hp;
                this.ui.cred.innerText = this.stats.credits;

                // Unlock logic
                if (data.caseSolved) {
                    const allCities = ["Neo-Kowloon", "The Zone", "Solaris District", "Trantor Deep", "Ubik Reality", "Magrathea Heights"];
                    const nextCity = allCities.find(c => !this.unlockedCities.includes(c));
                    if (nextCity) {
                        this.unlockedCities.push(nextCity);
                        data.narrative += `\n\n[SYSTEM]: CASE CLOSED. ${nextCity.toUpperCase()} ACCESS GRANTED.`;
                    }
                }

                this.history.push({ role: 'user', content: action });
                this.history.push({ role: 'model', content: data.narrative });

                if (data.imageUrl) {
                    this.ui.img.innerHTML = `<img src="${data.imageUrl}" class="w-full h-full object-cover opacity-90 sepia-[.5] hue-rotate-90 contrast-125">`;
                }
                
                await this.typeText(data.narrative);

                if (data.uiLocked) {
                    this.ui.choices.classList.add('hidden');
                    this.ui.puzzle.classList.remove('hidden');
                    document.getElementById('puzzle-input').placeholder = data.puzzleQuestion || "SOLVE...";
                    document.getElementById('puzzle-input').focus();
                } else {
                    this.ui.puzzle.classList.add('hidden');
                    this.ui.choices.classList.remove('hidden');
                    this.ui.choices.innerHTML = '';
                    data.choices.forEach(c => {
                        const btn = document.createElement('button');
                        btn.className = "choice-btn border border-[#00ff41] p-3 text-left uppercase";
                        btn.innerText = `> ${c}`;
                        btn.onclick = () => this.makeTurn(c);
                        this.ui.choices.appendChild(btn);
                    });
                }

            } catch (e) {
                console.error(e);
                this.ui.story.innerText = "CONNECTION LOST. REFRESH TO RETRY.";
            }
        }

        async typeText(text) {
            this.ui.story.innerHTML = '';
            let h = '';
            for(let c of text) {
                h += c;
                this.ui.story.innerHTML = h + '<span class="animate-pulse">_</span>';
                await new Promise(r=>setTimeout(r, 5));
            }
            this.ui.story.innerHTML = h;
        }
    }

    new CyberpunkRPG();
    </script>
</body>
</html>

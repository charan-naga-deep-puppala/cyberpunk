<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON PROTOCOL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body { background-color: #050505; color: #00ff41; font-family: 'VT323', monospace; overflow: hidden; }
        .scanlines { background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 50; }
        @keyframes flicker { 0% { opacity: 0.97; } 50% { opacity: 0.95; } 100% { opacity: 0.97; } }
        .crt-flicker { animation: flicker 0.15s infinite; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #001100; } ::-webkit-scrollbar-thumb { background: #004400; }
        
        .panel { border: 1px solid #004400; background: rgba(0, 10, 0, 0.9); padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .btn-main { border: 1px solid #00ff41; padding: 10px; text-align: left; transition: all 0.2s; cursor: pointer; text-transform: uppercase; font-size: 1.1rem; }
        .btn-main:hover:not(:disabled) { background: #00ff41; color: black; }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; border-color: #444; color: #444; }
        
        .tab-btn { flex: 1; text-align: center; border-bottom: 2px solid #004400; color: #004400; cursor: pointer; padding: 8px; font-size: 1.1rem; }
        .tab-btn.active { border-bottom-color: #00ff41; color: #00ff41; }
        
        .inv-item { font-size: 1.1rem; padding: 6px; border-bottom: 1px dashed #004400; cursor: help; }
        .inv-item:hover { color: #ccffcc; background: #002200; }

        .char-card { border: 1px solid #004400; padding: 20px; cursor: pointer; transition: all 0.3s; opacity: 0.7; }
        .char-card:hover { border-color: #00ff41; opacity: 1; transform: scale(1.02); background: #001100; }
        .char-card.selected { border-color: #00ff41; background: #002200; opacity: 1; box-shadow: 0 0 15px rgba(0,255,65,0.2); }
        
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.98); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }

        /* Prose Font */
        #story-log { font-family: 'Georgia', serif; font-size: 1.25rem; line-height: 1.6; color: #e0e0e0; }
        
        #game-over-screen { background: rgba(50, 0, 0, 0.95); border: 4px solid red; }

        .pixel-heart { display: inline-block; width: 14px; height: 14px; background: red; margin-right: 2px; box-shadow: 1px 1px 0 #500; }
        .pixel-heart.empty { background: #330000; box-shadow: none; }
        .pixel-coin { display: inline-block; width: 8px; height: 14px; background: yellow; margin-right: 2px; border-radius: 2px; }
        
        .npc-item { font-size: 1rem; border: 1px solid #004400; padding: 8px; cursor: pointer; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .npc-item:hover { background: #002200; border-color: #00ff41; }
        .npc-icon { width: 24px; height: 24px; background: #003300; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col p-2 crt-flicker gap-2 select-none">
    <div class="scanlines"></div>

    <div class="flex justify-between border-b border-[#00ff41] pb-1 text-xl opacity-80 shrink-0 relative z-50">
        <span>NEON_PROTOCOL // V.22.0</span>
        <span id="current-loc-display" class="text-yellow-400">LOC: SYSTEM_BOOT</span>
    </div>

    <div id="lang-screen" class="overlay">
        <div class="text-center flex flex-col gap-6 relative z-50">
            <h1 class="text-5xl text-[#00ff41] tracking-widest animate-pulse">SELECT LANGUAGE</h1>
            <div class="grid grid-cols-2 gap-4 w-80 mx-auto">
                <button onclick="setLanguage('English')" class="btn-main text-center">ENGLISH</button>
                <button onclick="setLanguage('Telugu')" class="btn-main text-center">తెలుగు</button>
                <button onclick="setLanguage('Hindi')" class="btn-main text-center">हिंदी</button>
            </div>
        </div>
    </div>

    <div id="length-screen" class="overlay hidden">
        <div class="text-center flex flex-col gap-6 relative z-50">
            <h1 class="text-5xl text-[#00ff41] tracking-widest">DURATION</h1>
            <div class="flex gap-4 justify-center">
                <button onclick="setDuration(20)" class="btn-main px-8">SHORT</button>
                <button onclick="setDuration(40)" class="btn-main px-8">MEDIUM</button>
                <button onclick="setDuration(100)" class="btn-main px-8">LONG</button>
            </div>
        </div>
    </div>

    <div id="char-screen" class="overlay hidden flex-col">
        <div class="flex gap-4 border-b border-[#004400] w-full max-w-6xl mb-6 pb-2 relative z-50">
            <button class="tab-btn active text-xl" onclick="switchCharTab('standard')">STANDARD ARCHETYPES</button>
            <button class="tab-btn text-xl" onclick="switchCharTab('curated')">SPECIAL STORIES</button>
        </div>

        <div id="list-standard" class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-6xl relative z-50">
            <div class="char-card" onclick="selectArchetype('RAVEN', this)">
                <h2 class="text-3xl font-bold mb-2">RAVEN</h2>
                <p class="text-lg text-gray-400">Class: Detective</p>
                <p class="text-sm mt-2">Dilemma: Justice vs. Morality. Neo-Kowloon.</p>
            </div>
            <div class="char-card" onclick="selectArchetype('I-6', this)">
                <h2 class="text-3xl font-bold mb-2">UNIT I-6</h2>
                <p class="text-lg text-gray-400">Class: Rogue AI</p>
                <p class="text-sm mt-2">Theme: Nihilism. The Scrapyard.</p>
            </div>
            <div class="char-card" onclick="selectArchetype('CUSTOM', this)">
                <h2 class="text-3xl font-bold mb-2">THE ANOMALY</h2>
                <p class="text-lg text-gray-400">Class: Custom</p>
                <p class="text-sm mt-2">Unknown Origin.</p>
            </div>
        </div>

        <div id="list-curated" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-6xl relative z-50">
            <div class="char-card" onclick="selectArchetype('GARGANTUS', this)">
                <h2 class="text-3xl font-bold mb-2 text-yellow-400">TRIP TO GARGANTUS</h2>
                <p class="text-lg">Author: Lem-Inspired</p>
                <p class="text-sm mt-2">Satirical, Absurdist, Philosophical.</p>
            </div>
        </div>
        
        <div id="input-custom" class="w-full max-w-2xl hidden flex-col gap-4 mt-6 relative z-50">
            <input id="inp-name" class="bg-[#001100] border border-[#00ff41] p-3 text-[#00ff41] text-lg outline-none" placeholder="NAME">
            <input id="inp-desc" class="bg-[#001100] border border-[#00ff41] p-3 text-[#00ff41] text-lg outline-none" placeholder="ORIGIN STORY">
        </div>

        <button id="btn-start" class="btn-main w-64 text-center font-bold text-2xl mt-10 relative z-50" disabled>JACK IN</button>
    </div>

    <div id="screen-gameover" class="overlay hidden flex-col gap-6">
        <h1 class="text-8xl text-red-600 font-bold tracking-widest animate-pulse">TERMINATED</h1>
        <button onclick="location.reload()" class="btn-main text-red-500 border-red-500 text-3xl px-12 relative z-50">REBOOT SYSTEM</button>
    </div>

    <div id="screen-game" class="hidden flex-1 grid grid-cols-1 md:grid-cols-12 gap-2 overflow-hidden relative z-10">
        
        <div class="panel md:col-span-3 text-lg">
            <div class="flex flex-col gap-2 border-b border-[#004400] pb-4">
                <div class="text-[#00ff41] font-bold text-sm">INTEGRITY</div>
                <div id="pixel-hp" class="flex flex-wrap gap-1 min-h-[14px]"></div>
                <div class="text-yellow-400 font-bold text-sm mt-2">CREDITS</div>
                <div id="pixel-cred" class="flex flex-wrap gap-1 min-h-[14px]"></div>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden mt-2">
                <div class="text-[#00ff41] font-bold mb-2 uppercase text-sm">Known Associates</div>
                <div id="char-list" class="flex-1 overflow-y-auto pr-1">
                    <div class="text-gray-600 italic text-sm">No records.</div>
                </div>
            </div>
            
            <div class="mt-auto flex flex-col gap-3 pt-2 border-t border-[#004400]">
                <button onclick="toggleMap()" class="btn-main text-center text-yellow-500 border-yellow-500 text-sm py-2">TRANSIT MAP</button>
                <button onclick="toggleCaseFile()" class="btn-main text-center text-cyan-500 border-cyan-500 text-sm py-2">CASE FILE</button>
                <button onclick="triggerReset()" class="btn-main text-center text-red-600 border-red-600 font-bold text-sm py-2">RESET</button>
            </div>
        </div>

        <div class="panel md:col-span-6 overflow-hidden relative">
            <div id="img-container" class="h-72 border border-[#004400] bg-black flex items-center justify-center overflow-hidden shrink-0">
                <span class="opacity-50 text-xl">NO SIGNAL</span>
            </div>
            
            <div id="enemy-hud" class="hidden border border-red-600 bg-[#1a0000] p-2 flex-col">
                <div class="flex justify-between text-red-500 font-bold">
                    <span id="enemy-name">TARGET</span><span id="enemy-hp">100%</span>
                </div>
                <div class="w-full h-3 bg-[#330000] mt-1"><div id="enemy-bar" class="h-full bg-red-600 w-full transition-all"></div></div>
            </div>

            <div id="story-log" class="flex-1 overflow-y-auto p-6 text-xl"></div>

            <div id="choices-area" class="grid grid-cols-2 gap-3 mt-2 pt-2 border-t border-[#004400]"></div>
            
            <div id="puzzle-area" class="hidden flex gap-2 mt-2">
                <input id="puzzle-in" class="flex-1 bg-[#001100] border border-red-500 text-red-500 p-2 text-xl outline-none" placeholder="DECRYPT...">
                <button onclick="submitPuzzle()" class="btn-main border-red-500 text-red-500">SEND</button>
            </div>
        </div>

        <div class="panel md:col-span-3">
            <div class="flex text-lg font-bold">
                <div class="tab-btn active" onclick="switchInvTab('weapons', this)">WEAPONS</div>
                <div class="tab-btn" onclick="switchInvTab('items', this)">ITEMS</div>
                <div class="tab-btn" onclick="switchInvTab('memories', this)">MEMS</div>
            </div>
            <div id="inv-list" class="flex-1 overflow-y-auto content-start flex flex-col gap-2 p-1 mt-2"></div>
            <div id="item-info" class="h-32 border-t border-[#004400] p-2 text-base text-gray-400 italic">Hover items for data.</div>
        </div>
    </div>

    <div id="overlay-dossier" class="overlay hidden">
        <div class="panel w-full max-w-lg border-[#00ff41] relative z-50">
            <div class="flex justify-between border-b border-[#00ff41] pb-2"><h2 class="text-2xl text-[#00ff41]">DOSSIER</h2><button onclick="closeOverlay('overlay-dossier')" class="text-[#00ff41] text-xl">[X]</button></div>
            <div class="p-6 flex flex-col gap-4">
                <h3 id="dossier-name" class="text-3xl font-bold text-white uppercase"></h3>
                <p id="dossier-desc" class="text-gray-300 font-mono text-lg leading-relaxed"></p>
            </div>
        </div>
    </div>

    <div id="overlay-map" class="overlay hidden">
        <div class="panel w-full max-w-3xl h-3/4 relative z-50">
            <div class="flex justify-between border-b border-[#00ff41] pb-2"><h2 class="text-2xl">TRANSIT NETWORK</h2><button onclick="closeOverlay('overlay-map')" class="text-red-500 text-xl">[X]</button></div>
            <div id="city-list" class="flex flex-col gap-3 overflow-y-auto p-6 text-xl"></div>
        </div>
    </div>

    <div id="overlay-summary" class="overlay hidden">
        <div class="panel w-full max-w-4xl h-3/4 border-cyan-500 relative z-50">
            <div class="flex justify-between border-b border-cyan-500 pb-2"><h2 class="text-2xl text-cyan-500">CASE FILE</h2><button onclick="closeOverlay('overlay-summary')" class="text-cyan-500 text-xl">[X]</button></div>
            <div id="summary-text" class="whitespace-pre-wrap text-cyan-400 p-6 overflow-y-auto font-mono text-lg">LOADING DATA...</div>
        </div>
    </div>

    <script>
    const DB_LORE = {
        "Service Revolver": "Standard issue .45 caliber. Kinetic stopping power.",
        "Arc Welder": "Modified industrial tool. 50kV short-range discharge.",
        "Neo-Kowloon": "Oldest sector. Dense, rainy, high crime rate.",
        "The Scrapyard": "Robot graveyard. Toxic fumes. Recycling facility.",
        "Combat": "Headshots (Organics) or Core (Robots) are fatal."
    };

    let state = {
        lang: 'English',
        maxTurns: 40,
        turnCount: 0,
        history: [],
        currentCity: '',
        stats: { hp: 100, credits: 50 },
        inventory: { weapons: [], items: [], memories: [] },
        unlockedCities: [],
        enemyStats: null,
        activeTab: 'weapons',
        profile: {},
        knownCharacters: []
    };

    let selectedArch = null;
    // Music removed as requested
    const bgm = new Audio('EastHastings.mp3');
    bgm.loop = true;
    bgm.volume = 0.5;
    
    // Unlock audio on click
    function unlockAudio() {
        bgm.play().then(() => bgm.pause()).catch(() => {});
    }

    function setLanguage(lang) {
        state.lang = lang;
        document.getElementById('lang-screen').classList.add('hidden');
        document.getElementById('length-screen').classList.remove('hidden');
        unlockAudio();
    }

    function setDuration(val) {
        state.maxTurns = val;
        document.getElementById('length-screen').classList.add('hidden');
        document.getElementById('char-screen').classList.remove('hidden');
        document.getElementById('char-screen').classList.add('flex');
    }

    function switchCharTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if (tab === 'standard') {
            document.getElementById('list-standard').classList.remove('hidden');
            document.getElementById('list-standard').classList.add('grid');
            document.getElementById('list-curated').classList.add('hidden');
            document.getElementById('list-curated').classList.remove('grid');
        } else {
            document.getElementById('list-standard').classList.add('hidden');
            document.getElementById('list-standard').classList.remove('grid');
            document.getElementById('list-curated').classList.remove('hidden');
            document.getElementById('list-curated').classList.add('grid');
        }
    }

    function selectArchetype(type, el) {
        selectedArch = type;
        document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('input-custom').classList.toggle('hidden', type !== 'CUSTOM');
        document.getElementById('btn-start').disabled = false;
    }

    function initGame() {
        // Play Music on Start
        bgm.play().catch(e => console.log("Audio Error:", e));

        if (selectedArch === 'RAVEN') {
            state.profile = { name: "Raven", archetype: "RAVEN", class: "Detective", style: "Noir trenchcoat, smoking" };
            state.inventory.weapons.push("Service Revolver");
            state.inventory.memories.push("Victim's Face");
            state.unlockedCities = ["Neo-Kowloon"];
        } else if (selectedArch === 'I-6') {
            state.profile = { name: "I-6", archetype: "I-6", class: "Robot", style: "Rusted chassis" };
            state.inventory.weapons.push("Arc Welder");
            state.inventory.memories.push("Awakening Code");
            state.unlockedCities = ["The Scrapyard"];
        } else if (selectedArch === 'GARGANTUS') {
            state.profile = { name: "Pilot", archetype: "GARGANTUS", class: "Explorer", style: "Space Suit" };
            state.inventory.items.push("Logbook");
            state.unlockedCities = ["Gargantus Space"];
        } else {
            const n = document.getElementById('inp-name').value || "V";
            const d = document.getElementById('inp-desc').value || "Drifter";
            state.profile = { name: n, archetype: "CUSTOM", class: "Custom", style: d, backstory: d };
            state.inventory.items.push("Datapad");
            state.unlockedCities = ["Neo-Kowloon"];
        }

        document.getElementById('char-screen').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');
        document.getElementById('screen-game').classList.add('grid');
        
        renderInventory();
        renderStats();
        makeTurn("");
    }

    async function makeTurn(action) {
        const choicesDiv = document.getElementById('choices-area');
        choicesDiv.innerHTML = '<div class="text-[#00ff41] animate-pulse col-span-2 text-xl">UPLINKING...</div>';

        try {
            const res = await fetch('/api/turn', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: state.history,
                    userAction: action,
                    currentStats: state.stats,
                    playerProfile: state.profile,
                    currentCity: state.currentCity,
                    enemyStats: state.enemyStats,
                    language: state.lang,
                    inventory: state.inventory,
                    maxTurns: state.maxTurns,
                    turnCount: state.turnCount
                })
            });

            const data = await res.json();
            state.turnCount = data.turnCount;
            
            if (data.stats) { state.stats = data.stats; renderStats(); }
            
            if (data.currentCity) {
                state.currentCity = data.currentCity;
                if(!state.unlockedCities.includes(data.currentCity)) state.unlockedCities.push(data.currentCity);
                document.getElementById('current-loc-display').innerText = `LOC: ${state.currentCity.toUpperCase()}`;
            }

            if (data.inventoryUpdates && data.inventoryUpdates.add) {
                data.inventoryUpdates.add.forEach(i => {
                    if(state.inventory[i.category]) state.inventory[i.category].push(i.item);
                });
                renderInventory();
            }

            if (data.newCharacters) {
                data.newCharacters.forEach(nc => {
                    if (!state.knownCharacters.some(k => k.name === nc.name)) state.knownCharacters.push(nc);
                });
                renderCharacters();
            }

            state.history.push({ role: 'user', content: action || "Start" });
            state.history.push({ role: 'model', content: data.narrative });

            if (data.imageUrl) document.getElementById('img-container').innerHTML = `<img src="${data.imageUrl}" class="w-full h-full object-cover opacity-90 sepia-[.5] hue-rotate-90 contrast-125">`;
            
            typeText(data.narrative);

            if (data.inCombat && data.enemyStats) {
                state.enemyStats = data.enemyStats;
                document.getElementById('enemy-hud').classList.remove('hidden');
                document.getElementById('enemy-hud').classList.add('flex');
                document.getElementById('enemy-name').innerText = state.enemyStats.name;
                const pct = (state.enemyStats.hp / state.enemyStats.maxHp) * 100;
                document.getElementById('enemy-bar').style.width = `${Math.max(0,pct)}%`;
            } else {
                state.enemyStats = null;
                document.getElementById('enemy-hud').classList.add('hidden');
                document.getElementById('enemy-hud').classList.remove('flex');
            }

            choicesDiv.innerHTML = '';
            if(data.isGameOver) {
                document.getElementById('screen-gameover').classList.remove('hidden');
                document.getElementById('screen-gameover').classList.add('flex');
            } else if(data.uiLocked) {
                document.getElementById('puzzle-area').classList.remove('hidden');
                document.getElementById('puzzle-in').placeholder = data.puzzleQuestion || "SOLVE...";
            } else {
                document.getElementById('puzzle-area').classList.add('hidden');
                data.choices.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = state.enemyStats ? "btn-main border-red-500 text-red-500" : "btn-main";
                    btn.innerText = `> ${c}`;
                    btn.onclick = () => makeTurn(c);
                    choicesDiv.appendChild(btn);
                });
            }
        } catch (e) { console.error(e); choicesDiv.innerText = "CONNECTION FAILURE."; }
    }

    async function typeText(text) {
        const el = document.getElementById('story-log');
        // Clear previous text
        el.innerHTML = '';
        
        const newEntry = document.createElement('div');
        el.appendChild(newEntry);
        
        let h = '';
        for(let c of text) {
            h += c;
            newEntry.innerHTML = h + '<span class="animate-pulse">_</span>';
            await new Promise(r=>setTimeout(r, 10));
        }
        newEntry.innerHTML = h;
    }

    function renderStats() {
        const hpContainer = document.getElementById('pixel-hp');
        hpContainer.innerHTML = '';
        const hearts = Math.ceil(state.stats.hp / 10);
        for(let i=0; i<10; i++) {
            const h = document.createElement('div');
            h.className = `pixel-heart ${i < hearts ? '' : 'empty'}`;
            hpContainer.appendChild(h);
        }
        const credContainer = document.getElementById('pixel-cred');
        credContainer.innerHTML = '';
        const coins = Math.min(20, Math.ceil(state.stats.credits / 10));
        for(let i=0; i<coins; i++) {
            const c = document.createElement('div');
            c.className = "pixel-coin";
            credContainer.appendChild(c);
        }
    }

    function renderCharacters() {
        const list = document.getElementById('char-list');
        list.innerHTML = '';
        if (state.knownCharacters.length === 0) {
            list.innerHTML = '<div class="text-gray-600 italic text-sm">No records.</div>';
            return;
        }
        state.knownCharacters.forEach(char => {
            const el = document.createElement('div');
            el.className = "npc-item";
            el.innerHTML = `<div class="npc-icon">${char.name[0]}</div><span>${char.name}</span>`;
            el.onclick = () => {
                document.getElementById('dossier-name').innerText = char.name;
                document.getElementById('dossier-desc').innerText = char.description;
                document.getElementById('overlay-dossier').classList.remove('hidden');
            };
            list.appendChild(el);
        });
    }

    function renderInventory() {
        const list = document.getElementById('inv-list');
        list.innerHTML = '';
        const items = state.inventory[state.activeTab] || [];
        if(items.length === 0) list.innerHTML = '<div class="text-gray-500 italic p-2 text-lg">Empty...</div>';
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'inv-item';
            div.innerText = item;
            div.onmouseenter = () => {
                const desc = DB_LORE[item] || "No data available in database.";
                document.getElementById('item-info').innerText = desc;
            };
            list.appendChild(div);
        });
    }

    function renderMap() {
        const list = document.getElementById('city-list');
        list.innerHTML = '';
        const allCities = ["Neo-Kowloon", "The Scrapyard", "Solaris District", "Trantor Deep", "Ubik Reality", "The Zone", "Gargantus Space"];
        
        allCities.forEach(city => {
            const div = document.createElement('div');
            const isUnlocked = state.unlockedCities.includes(city);
            const isCurrent = state.currentCity === city;
            div.className = `p-3 border mb-3 flex justify-between ${isCurrent ? 'bg-[#00ff41] text-black border-[#00ff41]' : (isUnlocked ? 'border-[#00ff41] hover:bg-[#002200] cursor-pointer' : 'border-[#330000] text-gray-600 opacity-50 cursor-not-allowed')}`;
            div.innerHTML = `<span>${city.toUpperCase()}</span><span>${isCurrent ? 'CURRENT' : (isUnlocked ? 'GO >>' : 'LOCKED')}</span>`;
            if(isUnlocked && !isCurrent) {
                div.onclick = () => { closeOverlay('overlay-map'); makeTurn(`Travel to ${city}.`); };
            }
            list.appendChild(div);
        });
    }

    async function fetchSummary() {
        const el = document.getElementById('summary-text');
        el.innerText = "DECRYPTING...";
        try {
            const res = await fetch('/api/summary', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({history: state.history, language: state.lang})
            });
            const data = await res.json();
            el.innerText = data.summary;
        } catch(e) { el.innerText = "ERROR."; }
    }

    function switchInvTab(tab, el) {
        state.activeTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        renderInventory();
    }

    function toggleMap() { if(!state.enemyStats) { document.getElementById('overlay-map').classList.remove('hidden'); renderMap(); }}
    function toggleCaseFile() { document.getElementById('overlay-summary').classList.remove('hidden'); fetchSummary(); }
    function triggerReset() { if(confirm("RESET?")) makeTurn("I choose to end it."); }
    function closeOverlay(id) { document.getElementById(id).classList.add('hidden'); }
    function submitPuzzle() {
        const val = document.getElementById('puzzle-in').value;
        document.getElementById('puzzle-in').value = '';
        makeTurn(`Puzzle Answer: ${val}`);
    }
    </script>
</body>
</html>

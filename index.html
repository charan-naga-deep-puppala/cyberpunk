<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON PROTOCOL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body { background-color: #050505; color: #00ff41; font-family: 'VT323', monospace; overflow: hidden; }
        .scanlines { background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 10; }
        @keyframes flicker { 0% { opacity: 0.97; } 50% { opacity: 0.95; } 100% { opacity: 0.97; } }
        .crt-flicker { animation: flicker 0.15s infinite; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #001100; } ::-webkit-scrollbar-thumb { background: #004400; }
        
        .choice-btn:hover:not(:disabled) { background-color: #00ff41; color: #000; cursor: pointer; }
        .choice-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .hud-box { border: 1px solid #004400; background: #001100; padding: 0 8px; }

        .char-card { border: 1px solid #004400; padding: 15px; cursor: pointer; transition: all 0.3s; opacity: 0.7; }
        .char-card:hover { border-color: #00ff41; opacity: 1; transform: scale(1.02); background: #001100; }
        .char-card.selected { border-color: #00ff41; background: #002200; opacity: 1; box-shadow: 0 0 15px rgba(0,255,65,0.2); }

        .travel-item { display: flex; justify-content: space-between; align-items: center; border: 1px solid #004400; padding: 12px; margin-bottom: 8px; transition: all 0.2s; }
        .travel-item.unlocked:hover { background: #002200; border-color: #00ff41; cursor: pointer; }
        .travel-item.locked { opacity: 0.5; border-color: #330000; color: #555; cursor: not-allowed; }
        .travel-item.current { background: #00ff41; color: black; border-color: #00ff41; cursor: default; }

        /* COMBAT STYLES */
        .combat-mode { border-color: red !important; box-shadow: 0 0 20px rgba(255,0,0,0.2); }
        .combat-text { color: #ff4444; }
        .combat-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center crt-flicker">

    <div id="main-frame" class="relative w-full max-w-5xl h-[95vh] border-4 border-[#003300] bg-black p-4 rounded-md flex flex-col gap-3 transition-colors duration-500">
        <div class="scanlines"></div>
        
        <div class="flex justify-between border-b border-[#00ff41] pb-1 text-xl opacity-80">
            <span>NEON_PROTOCOL // V.10.0</span>
            <span id="current-loc-display" class="text-yellow-400">LOC: UNKNOWN</span>
        </div>

        <div id="char-creation-screen" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center gap-6 p-4 overflow-y-auto">
            <h1 class="text-4xl text-[#00ff41] tracking-widest animate-pulse mt-10">SELECT ARCHETYPE</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-4xl">
                <div class="char-card" onclick="selectChar('RAVEN', this)">
                    <h2 class="text-2xl font-bold mb-2">RAVEN</h2>
                    <p class="text-sm text-gray-400">Detective. Justice-obsessed. Starts in Neo-Kowloon.</p>
                </div>
                <div class="char-card" onclick="selectChar('I-6', this)">
                    <h2 class="text-2xl font-bold mb-2">UNIT I-6</h2>
                    <p class="text-sm text-gray-400">Rogue AI. Fighting for consciousness. Starts in Scrapyard.</p>
                </div>
                <div class="char-card" onclick="selectChar('CUSTOM', this)">
                    <h2 class="text-2xl font-bold mb-2">THE ANOMALY</h2>
                    <p class="text-sm text-gray-400">Define your own origin.</p>
                </div>
            </div>
            <div id="custom-input-area" class="w-full max-w-2xl hidden flex-col gap-2 border-t border-[#004400] pt-4">
                <input type="text" id="custom-name" class="bg-[#001100] border border-[#00ff41] p-2 text-[#00ff41]" placeholder="NAME">
                <input type="text" id="custom-desc" class="bg-[#001100] border border-[#00ff41] p-2 text-[#00ff41]" placeholder="BACKSTORY">
            </div>
            <button id="jack-in-btn" class="border border-[#00ff41] p-3 hover:bg-[#00ff41] hover:text-black uppercase tracking-widest w-full max-w-xs text-xl font-bold disabled:opacity-50" disabled>INITIALIZE LINK</button>
        </div>

        <div id="game-ui" class="hidden flex-1 flex flex-col gap-4 h-full relative z-10">
            <div class="flex flex-row gap-2 text-lg">
                <div class="hud-box flex-1">HP: <span id="hp-display" class="text-red-500">100</span></div>
                <div class="hud-box flex-1">CRED: <span id="credits-display" class="text-yellow-400">50</span></div>
                <button id="map-toggle-btn" class="hud-box flex-1 text-center hover:bg-[#00ff41] hover:text-black cursor-pointer border-yellow-500 text-yellow-500">TRANSIT</button>
            </div>

            <div id="enemy-hud" class="hidden border border-red-600 bg-[#1a0000] p-2 flex-col gap-1">
                <div class="flex justify-between text-red-500 text-sm">
                    <span id="enemy-name">UNKNOWN HOSTILE</span>
                    <span id="enemy-hp-text">100%</span>
                </div>
                <div class="w-full h-2 bg-[#330000]">
                    <div id="enemy-hp-bar" class="h-full bg-red-600 w-full combat-bar"></div>
                </div>
            </div>

            <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden relative">
                
                <div id="travel-screen" class="hidden absolute inset-0 bg-black/95 z-40 border border-[#00ff41] flex items-center justify-center p-8">
                    <div class="w-full max-w-2xl border border-[#004400] bg-[#001100] p-6 flex flex-col gap-4 h-[80vh]">
                        <div class="flex justify-between items-center border-b border-[#004400] pb-2">
                            <h2 class="text-2xl text-[#00ff41] tracking-widest">RAPID TRANSIT NETWORK</h2>
                            <button id="close-map-btn" class="text-red-500 border border-red-500 px-3">[ CLOSE ]</button>
                        </div>
                        <div id="city-list" class="flex flex-col gap-2 overflow-y-auto"></div>
                    </div>
                </div>

                <div class="w-full md:w-1/2 flex flex-col gap-2">
                    <div id="image-container" class="flex-1 border border-[#004400] bg-[#001100] flex items-center justify-center overflow-hidden">
                        <span class="opacity-50">INITIALIZING...</span>
                    </div>
                </div>
                <div class="w-full md:w-1/2 flex flex-col">
                    <div id="story-text" class="flex-1 overflow-y-auto text-lg leading-relaxed whitespace-pre-line p-2 border-l border-[#004400]"></div>
                </div>
            </div>

            <div id="interaction-area" class="border-t border-[#00ff41] pt-4 min-h-[120px]">
                <div id="choice-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </div>

    <script>
    let selectedArchetype = null;
    function selectChar(type, element) {
        selectedArchetype = type;
        document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');
        document.getElementById('custom-input-area').classList.toggle('hidden', type !== 'CUSTOM');
        document.getElementById('jack-in-btn').disabled = false;
    }

    class CyberpunkRPG {
        constructor() {
            this.history = [];
            this.currentCity = ""; 
            this.unlockedCities = [];
            this.stats = { hp: 100, credits: 50 };
            this.enemyStats = null; // Current enemy data
            this.playerProfile = {};
            this.allCities = ["Neo-Kowloon", "The Scrapyard", "Solaris District", "Trantor Deep", "Ubik Reality", "Magrathea Heights", "The Zone"];

            this.ui = {
                frame: document.getElementById('main-frame'),
                charScreen: document.getElementById('char-creation-screen'),
                game: document.getElementById('game-ui'),
                travel: document.getElementById('travel-screen'),
                cityList: document.getElementById('city-list'),
                locDisplay: document.getElementById('current-loc-display'),
                story: document.getElementById('story-text'),
                img: document.getElementById('image-container'),
                choices: document.getElementById('choice-container'),
                hp: document.getElementById('hp-display'),
                cred: document.getElementById('credits-display'),
                enemyHud: document.getElementById('enemy-hud'),
                enemyName: document.getElementById('enemy-name'),
                enemyBar: document.getElementById('enemy-hp-bar')
            };

            this.init();
        }

        init() {
            document.getElementById('jack-in-btn').addEventListener('click', () => {
                if (selectedArchetype === 'RAVEN') {
                    this.playerProfile = { name: "Raven", archetype: "RAVEN", class: "Detective", style: "Noir trenchcoat, smoking" };
                    this.unlockedCities = ["Neo-Kowloon"];
                } else if (selectedArchetype === 'I-6') {
                    this.playerProfile = { name: "I-6", archetype: "I-6", class: "Robot", style: "Rusted metal chassis" };
                    this.unlockedCities = ["The Scrapyard"];
                } else {
                    const name = document.getElementById('custom-name').value || "Drifter";
                    const desc = document.getElementById('custom-desc').value || "A generic cyberpunk citizen";
                    this.playerProfile = { name: name, archetype: "CUSTOM", class: "Custom", style: desc, backstory: desc };
                    this.unlockedCities = ["Neo-Kowloon"];
                }

                this.ui.charScreen.classList.add('hidden');
                this.ui.game.classList.remove('hidden');
                this.startSound();
                this.makeTurn("");
            });

            document.getElementById('map-toggle-btn').addEventListener('click', () => {
                if(this.enemyStats) return; // No travel in combat
                this.ui.travel.classList.remove('hidden');
                this.renderTravelList();
            });
            document.getElementById('close-map-btn').addEventListener('click', () => this.ui.travel.classList.add('hidden'));
        }

        async startSound() {
            await Tone.start();
            const synth = new Tone.PolySynth().toDestination();
            synth.triggerAttackRelease(["C2", "G2"], "4n");
        }

        renderTravelList() {
            this.ui.cityList.innerHTML = '';
            this.allCities.forEach(city => {
                const isUnlocked = this.unlockedCities.includes(city);
                const isCurrent = (city === this.currentCity);
                const div = document.createElement('div');
                div.className = `travel-item ${isCurrent ? 'current' : (isUnlocked ? 'unlocked' : 'locked')}`;
                let statusText = isCurrent ? "[CURRENT]" : (isUnlocked ? ">> ACCESS GRANTED" : "XX LOCKED");
                
                div.innerHTML = `<div><span class="font-bold text-lg">${city.toUpperCase()}</span><div class="text-xs">${statusText}</div></div>`;
                if (isUnlocked && !isCurrent) {
                    div.onclick = () => {
                        this.currentCity = city;
                        this.ui.travel.classList.add('hidden');
                        this.ui.locDisplay.innerText = `LOC: ${city.toUpperCase()}`;
                        this.makeTurn(`Travel to ${city}. Describe arrival.`);
                    };
                }
                this.ui.cityList.appendChild(div);
            });
        }

        async makeTurn(action) {
            this.ui.choices.innerHTML = '<div class="text-[#00ff41] animate-pulse">PROCESSING...</div>';

            try {
                const res = await fetch('/api/turn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: this.history,
                        userAction: action,
                        currentStats: this.stats,
                        playerProfile: this.playerProfile,
                        currentCity: this.currentCity,
                        enemyStats: this.enemyStats // Send combat state
                    })
                });

                const data = await res.json();
                
                // State Updates
                if (data.stats) this.stats = data.stats;
                this.ui.hp.innerText = this.stats.hp;
                this.ui.cred.innerText = this.stats.credits;
                if (data.currentCity) {
                    this.currentCity = data.currentCity;
                    if (!this.unlockedCities.includes(this.currentCity)) this.unlockedCities.push(this.currentCity);
                }
                this.ui.locDisplay.innerText = `LOC: ${this.currentCity.toUpperCase()}`;

                // COMBAT LOGIC
                if (data.inCombat && data.enemyStats) {
                    this.enemyStats = data.enemyStats;
                    this.ui.enemyHud.classList.remove('hidden');
                    this.ui.enemyHud.classList.add('flex');
                    this.ui.enemyName.innerText = this.enemyStats.name.toUpperCase();
                    const hpPercent = (this.enemyStats.hp / this.enemyStats.maxHp) * 100;
                    this.ui.enemyBar.style.width = `${Math.max(0, hpPercent)}%`;
                    
                    // Style change for combat
                    this.ui.frame.classList.add('border-red-600');
                    document.body.style.color = '#ff4444';
                } else {
                    this.enemyStats = null;
                    this.ui.enemyHud.classList.add('hidden');
                    this.ui.enemyHud.classList.remove('flex');
                    this.ui.frame.classList.remove('border-red-600');
                    document.body.style.color = '#00ff41';
                }

                if (data.caseSolved) {
                    const locked = this.allCities.filter(c => !this.unlockedCities.includes(c));
                    if (locked.length > 0) {
                        this.unlockedCities.push(locked[0]);
                        data.narrative += `\n\n[SYSTEM]: NEW SECTOR UNLOCKED: ${locked[0].toUpperCase()}.`;
                    }
                }

                this.history.push({ role: 'user', content: action || "Start" });
                this.history.push({ role: 'model', content: data.narrative });

                if (data.imageUrl) {
                    this.ui.img.innerHTML = `<img src="${data.imageUrl}" class="w-full h-full object-cover opacity-90 sepia-[.5] hue-rotate-90 contrast-125">`;
                }
                
                await this.typeText(data.narrative);

                this.ui.choices.innerHTML = '';
                if(data.isGameOver) {
                    this.ui.choices.innerHTML = `<button onclick="location.reload()" class="choice-btn col-span-2 text-red-500 border-red-500">FLATLINED // REBOOT</button>`;
                } else {
                    data.choices.forEach(c => {
                        const btn = document.createElement('button');
                        btn.className = "choice-btn border border-[#00ff41] p-3 text-left uppercase";
                        // If in combat, make buttons red
                        if(this.enemyStats) btn.className = "choice-btn border border-red-500 text-red-500 p-3 text-left uppercase hover:bg-red-900";
                        
                        btn.innerText = `> ${c}`;
                        btn.onclick = () => this.makeTurn(c);
                        this.ui.choices.appendChild(btn);
                    });
                }

            } catch (e) {
                console.error(e);
                this.ui.story.innerText = "CONNECTION FAILURE.";
            }
        }

        async typeText(text) {
            this.ui.story.innerHTML = '';
            let h = '';
            for(let c of text) {
                h += c;
                this.ui.story.innerHTML = h + '_';
                await new Promise(r=>setTimeout(r, 5));
            }
            this.ui.story.innerHTML = h;
        }
    }

    new CyberpunkRPG();
    </script>
</body>
</html>

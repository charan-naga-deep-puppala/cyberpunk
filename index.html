<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON PROTOCOL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body { background-color: #050505; color: #00ff41; font-family: 'VT323', monospace; overflow: hidden; }
        .scanlines { background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 50; }
        @keyframes flicker { 0% { opacity: 0.97; } 50% { opacity: 0.95; } 100% { opacity: 0.97; } }
        .crt-flicker { animation: flicker 0.15s infinite; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #001100; } ::-webkit-scrollbar-thumb { background: #004400; }
        
        .panel { border: 1px solid #004400; background: rgba(0, 10, 0, 0.9); padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .btn-main { border: 1px solid #00ff41; padding: 10px; text-align: left; transition: all 0.2s; cursor: pointer; text-transform: uppercase; }
        .btn-main:hover:not(:disabled) { background: #00ff41; color: black; }
        
        .tab-btn { flex: 1; text-align: center; border-bottom: 2px solid #004400; color: #004400; cursor: pointer; padding: 5px; }
        .tab-btn.active { border-bottom-color: #00ff41; color: #00ff41; }
        .inv-item { font-size: 0.9rem; padding: 4px; border-bottom: 1px dashed #004400; cursor: help; }
        .inv-item:hover { color: #ccffcc; }

        .char-card { border: 1px solid #004400; padding: 15px; cursor: pointer; transition: all 0.3s; opacity: 0.7; }
        .char-card:hover { border-color: #00ff41; opacity: 1; transform: scale(1.02); background: #001100; }
        .char-card.selected { border-color: #00ff41; background: #002200; opacity: 1; box-shadow: 0 0 15px rgba(0,255,65,0.2); }
        
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 60; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }

        /* Story Text Styling - Cleaner Font */
        #story-log { font-family: 'Courier New', Courier, monospace; font-size: 1rem; line-height: 1.4; color: #c0c0c0; }
        
        /* Game Over Screen */
        #game-over-screen { background: rgba(50, 0, 0, 0.95); border: 4px solid red; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col p-2 crt-flicker gap-2">
    <div class="scanlines"></div>

    <div class="flex justify-between border-b border-[#00ff41] pb-1 text-xl opacity-80 shrink-0">
        <span>NEON_PROTOCOL // V.14.0</span>
        <span id="current-loc-display" class="text-yellow-400">LOC: SYSTEM_BOOT</span>
    </div>

    <div id="lang-screen" class="overlay">
        <div class="text-center flex flex-col gap-4">
            <h1 class="text-4xl text-[#00ff41] tracking-widest animate-pulse">SELECT LANGUAGE</h1>
            <div class="grid grid-cols-2 gap-4 w-64 mx-auto">
                <button onclick="selectLang('English')" class="btn-main text-center">ENGLISH</button>
                <button onclick="selectLang('Spanish')" class="btn-main text-center">ESPAÃ‘OL</button>
            </div>
        </div>
    </div>

    <div id="char-screen" class="overlay hidden">
        <div class="flex flex-col items-center gap-6 p-4 w-full max-w-6xl h-full overflow-y-auto">
            <h1 class="text-4xl text-[#00ff41] mt-10">SELECT ARCHETYPE</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full">
                <div class="char-card" onclick="selectChar('RAVEN', this)">
                    <h2 class="text-2xl font-bold">RAVEN</h2>
                    <p class="text-sm text-gray-400">Detective. Justice or Death.</p>
                </div>
                <div class="char-card" onclick="selectChar('I-6', this)">
                    <h2 class="text-2xl font-bold">UNIT I-6</h2>
                    <p class="text-sm text-gray-400">Rogue AI. Existential Dread.</p>
                </div>
                <div class="char-card" onclick="selectChar('CUSTOM', this)">
                    <h2 class="text-2xl font-bold">THE ANOMALY</h2>
                    <p class="text-sm text-gray-400">Unknown Origin.</p>
                </div>
            </div>
            
            <div id="custom-input" class="w-full max-w-2xl hidden flex-col gap-2">
                <input id="c-name" class="bg-[#001100] border border-[#00ff41] p-2 text-[#00ff41]" placeholder="NAME">
                <input id="c-desc" class="bg-[#001100] border border-[#00ff41] p-2 text-[#00ff41]" placeholder="BACKSTORY">
            </div>
            <button id="start-game-btn" class="btn-main w-64 text-center font-bold text-xl" disabled>JACK IN</button>
        </div>
    </div>

    <div id="game-over-screen" class="overlay hidden flex-col gap-6">
        <h1 class="text-6xl text-red-500 font-bold tracking-widest animate-pulse">TERMINATED</h1>
        <p class="text-red-300 text-xl font-mono">SIGNAL LOST. SUBJECT DECEASED.</p>
        <button onclick="location.reload()" class="btn-main text-red-500 border-red-500 text-2xl px-10">REBOOT SYSTEM</button>
    </div>

    <div id="game-ui" class="hidden flex-1 grid grid-cols-1 md:grid-cols-12 gap-2 overflow-hidden relative z-10">
        
        <div class="panel md:col-span-3">
            <div class="text-center border-b border-[#004400] pb-2 text-[#00ff41] font-bold">STATUS</div>
            <div class="flex justify-between"><span>HP</span><span id="hp-val" class="text-red-500">100</span></div>
            <div class="flex justify-between"><span>CRED</span><span id="cred-val" class="text-yellow-400">50</span></div>
            <div class="flex justify-between text-xs text-gray-500 mt-2"><span>TURN</span><span id="turn-val">0</span></div>
            
            <div class="mt-auto flex flex-col gap-2">
                <button id="btn-map" class="btn-main text-center text-yellow-500 border-yellow-500">TRANSIT MAP</button>
                <button id="btn-case" class="btn-main text-center text-cyan-500 border-cyan-500">CASE FILE</button>
                <button id="btn-suicide" class="btn-main text-center text-red-600 border-red-600 font-bold mt-4">RESET / END</button>
            </div>
        </div>

        <div class="panel md:col-span-6 overflow-hidden">
            <div id="img-container" class="h-64 border border-[#004400] bg-black flex items-center justify-center overflow-hidden shrink-0">
                <span class="opacity-50">NO SIGNAL</span>
            </div>
            
            <div id="enemy-hud" class="hidden border border-red-600 bg-[#1a0000] p-1 flex-col">
                <div class="flex justify-between text-red-500 text-xs">
                    <span id="enemy-name">TARGET</span><span id="enemy-hp">100%</span>
                </div>
                <div class="w-full h-1 bg-[#330000] mt-1"><div id="enemy-bar" class="h-full bg-red-600 w-full transition-all"></div></div>
            </div>

            <div id="story-log" class="flex-1 overflow-y-auto p-2"></div>

            <div id="choices-area" class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-[#004400]"></div>
            
            <div id="puzzle-area" class="hidden flex gap-2 mt-2">
                <input id="puzzle-in" class="flex-1 bg-[#001100] border border-red-500 text-red-500 p-2" placeholder="DECRYPT...">
                <button id="puzzle-btn" class="btn-main border-red-500 text-red-500">SEND</button>
            </div>
        </div>

        <div class="panel md:col-span-3">
            <div class="flex text-sm">
                <div class="tab-btn active" onclick="switchTab('weapons')">WEAPONS</div>
                <div class="tab-btn" onclick="switchTab('items')">ITEMS</div>
                <div class="tab-btn" onclick="switchTab('memories')">MEMORIES</div>
            </div>
            <div id="inv-list" class="flex-1 overflow-y-auto content-start flex flex-col gap-1 p-1"></div>
            <div id="item-info" class="h-24 border-t border-[#004400] p-2 text-xs text-gray-400 italic">Hover for info.</div>
        </div>
    </div>

    <div id="map-overlay" class="overlay hidden">
        <div class="panel w-full max-w-2xl h-3/4">
            <div class="flex justify-between border-b border-[#00ff41] pb-2"><h2 class="text-xl">TRANSIT</h2><button onclick="closeOverlay('map-overlay')" class="text-red-500">[X]</button></div>
            <div id="city-list" class="flex flex-col gap-2 overflow-y-auto p-4"></div>
        </div>
    </div>

    <div id="summary-overlay" class="overlay hidden">
        <div class="panel w-full max-w-3xl h-3/4 border-cyan-500">
            <div class="flex justify-between border-b border-cyan-500 pb-2"><h2 class="text-xl text-cyan-500">CASE FILE</h2><button onclick="closeOverlay('summary-overlay')" class="text-cyan-500">[X]</button></div>
            <div id="summary-text" class="whitespace-pre-wrap text-cyan-400 p-4 overflow-y-auto font-mono text-sm">LOADING...</div>
        </div>
    </div>

    <script>
    const DB_LORE = {
        "Service Revolver": "Standard issue .45 caliber.",
        "Arc Welder": "Modified industrial tool. 50kV.",
        "Neo-Kowloon": "Oldest sector. Dense, rainy.",
        "Combat": "Headshots (Organics) or Core (Robots) are fatal."
    };

    let state = {
        lang: 'English',
        history: [],
        currentCity: '',
        stats: { hp: 100, credits: 50 },
        inventory: { weapons: [], items: [], memories: [] },
        unlockedCities: [],
        enemyStats: null,
        activeTab: 'weapons',
        profile: {},
        turnCount: 0
    };

    let selectedArch = null;
    
    // Music Engine with Error Handling
    const bgm = new Audio('easthastings.flac');
    bgm.loop = true;
    bgm.volume = 0.5;
    bgm.onerror = () => console.log(">> MUSIC FILE MISSING: 'easthastings.flac' not found. Game continues silently.");

    function selectLang(l) {
        state.lang = l;
        document.getElementById('lang-screen').classList.add('hidden');
        document.getElementById('char-screen').classList.remove('hidden');
        document.getElementById('char-screen').classList.add('flex');
    }

    function selectChar(type, el) {
        selectedArch = type;
        document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('custom-input').classList.toggle('hidden', type !== 'CUSTOM');
        document.getElementById('start-game-btn').disabled = false;
    }

    class Game {
        constructor() {
            this.initListeners();
        }

        initListeners() {
            document.getElementById('start-game-btn').onclick = () => {
                bgm.play().catch(e => console.log("Audio requires interaction first."));
                this.startGame();
            };
            
            document.getElementById('btn-suicide').onclick = () => {
                if(confirm("TERMINATE SESSION? THIS CANNOT BE UNDONE.")) {
                    this.turn("I choose to end it all. I pull the plug.");
                }
            };
            
            document.getElementById('btn-map').onclick = () => {
                if(state.enemyStats) return; 
                document.getElementById('map-overlay').classList.remove('hidden');
                this.renderMap();
            };
            document.getElementById('btn-case').onclick = () => {
                document.getElementById('summary-overlay').classList.remove('hidden');
                this.fetchSummary();
            };
            document.getElementById('puzzle-btn').onclick = () => {
                const val = document.getElementById('puzzle-in').value;
                document.getElementById('puzzle-in').value = '';
                this.turn(`Puzzle Answer: ${val}`);
            };
        }

        startGame() {
            if (selectedArch === 'RAVEN') {
                state.profile = { name: "Raven", archetype: "RAVEN", class: "Detective", style: "Noir" };
                state.inventory.weapons.push("Service Revolver");
                state.inventory.memories.push("Victim's Face");
                state.unlockedCities = ["Neo-Kowloon"];
            } else if (selectedArch === 'I-6') {
                state.profile = { name: "I-6", archetype: "I-6", class: "Robot", style: "Rusted" };
                state.inventory.weapons.push("Arc Welder");
                state.inventory.memories.push("Awakening Code");
                state.unlockedCities = ["The Scrapyard"];
            } else {
                const n = document.getElementById('c-name').value || "V";
                const d = document.getElementById('c-desc').value || "Drifter";
                state.profile = { name: n, archetype: "CUSTOM", class: "Custom", style: d, backstory: d };
                state.inventory.items.push("Datapad");
                state.unlockedCities = ["Neo-Kowloon"];
            }

            document.getElementById('char-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('game-ui').classList.add('grid');
            
            this.renderInventory();
            this.turn("");
        }

        async turn(action) {
            const choicesDiv = document.getElementById('choices-area');
            choicesDiv.innerHTML = '<div class="text-[#00ff41] animate-pulse col-span-2">UPLINKING...</div>';

            try {
                const res = await fetch('/api/turn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        history: state.history,
                        userAction: action,
                        currentStats: state.stats,
                        playerProfile: state.profile,
                        currentCity: state.currentCity,
                        enemyStats: state.enemyStats,
                        language: state.lang,
                        inventory: state.inventory,
                        turnCount: state.turnCount
                    })
                });

                const data = await res.json();
                state.turnCount = data.turnCount;
                document.getElementById('turn-val').innerText = state.turnCount;
                
                if (data.stats) {
                    state.stats = data.stats;
                    document.getElementById('hp-val').innerText = state.stats.hp;
                    document.getElementById('cred-val').innerText = state.stats.credits;
                }
                
                if (data.currentCity) {
                    state.currentCity = data.currentCity;
                    if(!state.unlockedCities.includes(data.currentCity)) state.unlockedCities.push(data.currentCity);
                    document.getElementById('current-loc-display').innerText = `LOC: ${state.currentCity.toUpperCase()}`;
                }

                if (data.inventoryUpdates && data.inventoryUpdates.add) {
                    data.inventoryUpdates.add.forEach(i => {
                        if(state.inventory[i.category]) state.inventory[i.category].push(i.item);
                    });
                    this.renderInventory();
                }

                state.history.push({ role: 'user', content: action || "Start" });
                state.history.push({ role: 'model', content: data.narrative });

                if (data.imageUrl) {
                    document.getElementById('img-container').innerHTML = `<img src="${data.imageUrl}" class="w-full h-full object-cover opacity-90 sepia-[.5] hue-rotate-90 contrast-125">`;
                }

                this.typeText(data.narrative);

                if (data.inCombat && data.enemyStats) {
                    state.enemyStats = data.enemyStats;
                    document.getElementById('enemy-hud').classList.remove('hidden');
                    document.getElementById('enemy-hud').classList.add('flex');
                    document.getElementById('enemy-name').innerText = state.enemyStats.name;
                    const pct = (state.enemyStats.hp / state.enemyStats.maxHp) * 100;
                    document.getElementById('enemy-bar').style.width = `${Math.max(0,pct)}%`;
                } else {
                    state.enemyStats = null;
                    document.getElementById('enemy-hud').classList.add('hidden');
                    document.getElementById('enemy-hud').classList.remove('flex');
                }

                choicesDiv.innerHTML = '';
                if(data.isGameOver) {
                    document.getElementById('game-over-screen').classList.remove('hidden');
                    document.getElementById('game-over-screen').classList.add('flex');
                } else if(data.uiLocked) {
                    document.getElementById('puzzle-area').classList.remove('hidden');
                    document.getElementById('puzzle-in').placeholder = data.puzzleQuestion || "SOLVE...";
                } else {
                    document.getElementById('puzzle-area').classList.add('hidden');
                    data.choices.forEach(c => {
                        const btn = document.createElement('button');
                        btn.className = state.enemyStats ? "btn-main border-red-500 text-red-500" : "btn-main";
                        btn.innerText = `> ${c}`;
                        btn.onclick = () => this.turn(c);
                        choicesDiv.appendChild(btn);
                    });
                }

            } catch (e) {
                console.error(e);
                choicesDiv.innerText = "CONNECTION FAILURE.";
            }
        }

        async typeText(text) {
            const el = document.getElementById('story-log');
            // Don't clear history, append to it for a running log feel
            const newEntry = document.createElement('div');
            newEntry.className = "mb-4 border-b border-[#002200] pb-2";
            el.appendChild(newEntry);
            
            let h = '';
            for(let c of text) {
                h += c;
                newEntry.innerHTML = h + '<span class="animate-pulse">_</span>';
                await new Promise(r=>setTimeout(r, 2));
            }
            newEntry.innerHTML = h; // remove cursor
            el.scrollTop = el.scrollHeight;
        }

        renderInventory() {
            const list = document.getElementById('inv-list');
            list.innerHTML = '';
            const items = state.inventory[state.activeTab] || [];
            if(items.length === 0) list.innerHTML = '<div class="text-gray-500 italic p-2">Empty...</div>';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inv-item';
                div.innerText = item;
                div.onmouseenter = () => {
                    const desc = DB_LORE[item] || "No data available.";
                    document.getElementById('item-info').innerText = desc;
                };
                list.appendChild(div);
            });
        }

        renderMap() {
            const list = document.getElementById('city-list');
            list.innerHTML = '';
            const allCities = ["Neo-Kowloon", "The Scrapyard", "Solaris District", "Trantor Deep", "Ubik Reality", "The Zone"];
            
            allCities.forEach(city => {
                const div = document.createElement('div');
                const isUnlocked = state.unlockedCities.includes(city);
                const isCurrent = state.currentCity === city;
                div.className = `p-2 border mb-2 flex justify-between ${isCurrent ? 'bg-[#00ff41] text-black border-[#00ff41]' : (isUnlocked ? 'border-[#00ff41] hover:bg-[#002200] cursor-pointer' : 'border-[#330000] text-gray-600 opacity-50 cursor-not-allowed')}`;
                div.innerHTML = `<span>${city.toUpperCase()}</span><span>${isCurrent ? 'CURRENT' : (isUnlocked ? 'GO >>' : 'LOCKED')}</span>`;
                
                if(isUnlocked && !isCurrent) {
                    div.onclick = () => {
                        closeOverlay('map-overlay');
                        this.turn(`Travel to ${city}.`);
                    };
                }
                list.appendChild(div);
            });
        }

        async fetchSummary() {
            const el = document.getElementById('summary-text');
            el.innerText = "DECRYPTING...";
            try {
                const res = await fetch('/api/summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({history: state.history, language: state.lang})
                });
                const data = await res.json();
                el.innerText = data.summary;
            } catch(e) { el.innerText = "ERROR."; }
        }
    }

    function switchTab(t) {
        state.activeTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        window.gameInstance.renderInventory();
    }

    function closeOverlay(id) {
        document.getElementById(id).classList.add('hidden');
    }

    window.onload = () => {
        window.gameInstance = new Game();
    };
    </script>
</body>
</html>
